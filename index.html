<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>Dutch Flashcards</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF9F1C">
    <link rel="icon" href="/flashcards/favicon.ico"> 
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- STYLING (Compact Mobile Fix) --- */
        :root {
            --primary: #FF9F1C; --primary-dark: #e08000; --secondary: #2EC4B6;
            --bg-app: #F4F6F8; --bg-card: #FFFFFF; --text-main: #1A1A1A; --text-sub: #788591;
            --color-again: #FF595E; --color-hard: #FFCA3A; --color-good: #8AC926; --color-easy: #1982C4;
            --radius-lg: 20px; --radius-md: 12px;
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* --- SENTENCE STYLING (Easy to adjust) --- */
        .sentence-text {
            margin-top: 15px;
            font-size: 1.6rem;      /* Change size here */
            color: #555;            /* Change color here */
            font-style: italic;     /* Change style here */
            text-align: center;
            max-width: 90%;
            line-height: 1.4;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            -webkit-text-size-adjust: 100%; 
        }

        html { 
            font-size: 62.5%; 
            height: 100dvh; 
            width: 100%; 
            overflow: hidden; 
        }

        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: var(--bg-app); 
            color: var(--text-main); 
            height: 100%; 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            overscroll-behavior-y: none;
            min-height: -webkit-fill-available;
        }

        /* Screen Visibility */
        .screen { display: none; width: 100%; height: 100dvh; flex-direction: column; background: var(--bg-app); overflow: hidden; }
        .screen.active { display: flex; }

        /* Layout */
        #app-container { display: flex; flex-direction: column; position: relative; overflow: hidden; width: 100%; height: 100%; }
        
        .content-scroll { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden; 
            padding: 12px; 
            padding-bottom: calc(40px + var(--safe-area-bottom)); 
            display: flex; 
            flex-direction: column; 
            -webkit-overflow-scrolling: touch;
            min-height: 0; 
            overscroll-behavior-y: contain; 
        }
        
        .list-scroll { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden; 
            padding: 12px; 
            padding-top: 0; 
            padding-bottom: calc(40px + var(--safe-area-bottom)); 
            min-height: 0; 
            -webkit-overflow-scrolling: touch; 
            overscroll-behavior-y: contain;
        }
        
        .fixed-controls { flex-shrink: 0; padding: 12px; background: var(--bg-app); z-index: 10; border-bottom: 1px solid rgba(0,0,0,0.05); }

        .app-header { 
            height: calc(50px + var(--safe-area-top)); 
            padding-top: var(--safe-area-top); 
            background: var(--bg-card); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding-left: 12px; 
            padding-right: 12px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            z-index: 50; 
            flex-shrink: 0; 
        }
        
        .header-title { 
            font-weight: 700; 
            font-size: 2.0rem; 
            color: var(--text-main); 
            text-align: center; 
            position: absolute; left: 50%; transform: translateX(-50%); width: 100%; 
            pointer-events: none; 
            white-space: nowrap; 
        }
        
        .btn-icon { background: none; border: none; font-size: 2.4rem; cursor: pointer; padding: 8px; z-index: 2; }
        .btn-text { background: none; border: none; font-size: 1.4rem; font-weight: 600; color: var(--primary); cursor: pointer; z-index: 2; }

        .container-elevated { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 12px; padding: 16px; }
        
        .progress-widget { 
            background: #F8F9FA; 
            border-radius: var(--radius-md); 
            padding: 16px 10px; 
            margin-top: 10px; 
            width: 100%; 
        }
        .pw-grid { 
            display: grid; 
            grid-template-columns: max-content 1fr 10px 1fr; 
            align-items: center; 
            row-gap: 5px; 
            column-gap: 5px;
            width: 100%;
        }
        .pw-head { font-size: 1.4rem; font-weight: 700; color: #ADB5BD; text-align: center; line-height: 1; }
        .pw-label { font-size: 1.4rem; font-weight: 600; color: var(--text-sub); text-align: right; padding-right: 15px; white-space: nowrap; }
        .pw-val { font-size: 2.2rem; font-weight: 800; color: var(--primary); text-align: center; line-height: 1; }
        .pw-div-vert { width: 2px; height: 30px; background: #E9ECEF; margin: 0 auto; border-radius: 2px; }

        .menu-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-top: 5px; 
        }
        .menu-btn { 
            background: var(--bg-card); 
            border: none; 
            border-radius: var(--radius-lg); 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.04); 
            cursor: pointer; 
            min-height: 130px; 
            width: 100%; 
        }
        .menu-icon { font-size: 5rem; line-height: 1; }
        .menu-text { font-weight: 700; font-size: 1.6rem; color: var(--text-main); }

        .flashcard-stage { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 16px; perspective: 1000px; padding-bottom: 120px; }
        
        .progress-track { width: 100%; max-width: 600px; height: 30px; background: #e0e0e0; border-radius: 15px; margin-bottom: 16px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        .progress-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; font-weight: 700; color: var(--text-main); }

        .flashcard { width: 100%; max-width: 600px; aspect-ratio: 4/5; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard.no-transition { transition: none !important; }
        
        .face { 
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            border-radius: 20px; background: var(--bg-card); box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            display: flex; flex-direction: column; padding: 20px; border: 1px solid rgba(0,0,0,0.02);
            pointer-events: none; 
            transition: z-index 0s linear 0.3s; 
        }
        .face.back { transform: rotateY(180deg); }

        .flashcard:not(.flipped) .face.front { pointer-events: auto; z-index: 10; }
        .flashcard.flipped .face.back { pointer-events: auto; z-index: 10; }
        .flashcard.flipped .face.front { z-index: 0; }
        .flashcard:not(.flipped) .face.back { z-index: 0; }

        .face-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .lang-flag { font-size: 3rem; }
        .card-status { font-size: 1.2rem; font-weight: 700; padding: 4px 10px; background: #eee; border-radius: 100px; color: #666; }
        .face-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; overflow:hidden; }
        .word-text { font-size: 3.2rem; font-weight: 700; text-align: center; word-break: break-word; line-height: 1.2; }
        .hint-image { max-width: 100%; max-height: 200px; border-radius: 12px; object-fit: contain; background: #f8f8f8; }

        .tts-btn { position: absolute; bottom: 15px; left: 15px !important; right: auto !important; background: none; border: none; font-size: 2.5rem; cursor: pointer; z-index: 10; }
        .hint-btn { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); background: none; border: none; font-size: 2.5rem; cursor: pointer; z-index: 10; }
        .edit-card-btn { position: absolute; bottom: 15px; right: 15px; background: #eee; border: none; border-radius: 10px; padding: 10px 20px; font-weight: 700; font-size: 1.3rem; cursor: pointer; z-index: 10; }

        .review-controls { position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px; padding-bottom: calc(20px + var(--safe-area-bottom)); background: rgba(255,255,255,0.95); border-top: 1px solid #eee; display: flex; gap: 10px; z-index: 100; }
        .rating-btn { flex: 1; border: none; padding: 25px 0; border-radius: 12px; font-weight: 700; color: white; font-size: 1.6rem; cursor: pointer; }
        
        .search-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .search-input { flex:1; padding: 14px; border: 1px solid #ddd; border-radius: 12px; font-size: 1.6rem; }
        
        #screen-wordReview .search-input { font-size: 1.8rem; margin-bottom: 8px; }
        #screen-wordReview .filter-pill { font-size: 1.3rem; padding: 6px 14px; }
        
        .filter-row { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 5px; }
        .filter-pill { background: #eee; border: none; padding: 8px 16px; border-radius: 20px; font-size: 1.2rem; font-weight: 600; white-space: nowrap; cursor: pointer; }
        .filter-pill.active { background: var(--text-main); color: white; }
        
        .ri-text { font-size: 1.8rem; font-weight: 700; }
        .ri-sub { font-size: 1.4rem; color: #777; }

        .edit-label { font-size: 1.4rem; font-weight: 700; color: var(--text-sub); margin-bottom: 5px; display: block; margin-top: 15px; }
        .edit-input { width: 100%; padding: 16px; font-size: 1.8rem; border: 1px solid #ddd; border-radius: 12px; font-weight: 600; background: #fff; }
        .edit-preview-img { width: 100%; height: 200px; object-fit: contain; background: #eee; border-radius: 12px; margin-top: 8px; margin-bottom: 8px; border: 1px solid #ddd; }
        .btn-large { width: 100%; padding: 16px; background: var(--primary); color: white; font-size: 1.6rem; font-weight: 700; border: none; border-radius: 12px; margin-top: 15px; cursor: pointer; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); margin-top: 10px; }
        .btn-danger { background: var(--color-again); margin-top: 10px; }

        .image-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px; 
            margin-top: 10px; 
        }
        .image-item { aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 3px solid transparent; cursor: pointer; }
        .image-item.selected { border-color: var(--primary); }
        .image-item img { width: 100%; height: 100%; object-fit: cover; }

        .chart-heading { font-size: 1.8rem; font-weight: 700; color: var(--text-main); margin-bottom: 5px; text-align: left; position: relative; }
        .chart-wrapper { width: 100%; height: 250px; overflow: hidden; }

        .hidden { display: none !important; }
        .center-msg { text-align: center; color: black; margin-top: 20px; font-size: 2rem; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #F4F6F8; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="app">
    <div id="loading-overlay" v-if="loading.show">
        <div style="font-size: 5rem; font-weight: 800; margin-bottom: 20px;">üá≥üá± Dutch Cards</div>
        <div style="font-size: 1.5rem; color: #666;">{{ loading.msg }}</div>
        <div style="margin-top: 15px; color: #999;">v{{ appVersion }}</div>
    </div>

    <div id="app-container">
        
        <div id="screen-menu" class="screen" :class="{ active: !loading.show && currentScreen === 'menu' }">
            <div class="app-header">
                <div class="header-title">üá≥üá± Dutch Flashcards üá¨üáß</div>
            </div>
            <div class="content-scroll">
                <div class="container-elevated"> 
                    <div class="header-title" style="font-size:2rem; text-align:center; margin-bottom:30px; position: relative; transform: none; left: auto; color:#788591;">Today's Progress</div>
                    <div class="progress-widget">
                        <div class="pw-grid">
                            <div></div> <div class="pw-head">NEW</div> <div class="pw-div-vert"></div> <div class="pw-head">REVIEW</div>
                            <div class="pw-label">Due Today</div>
                            <div class="pw-val">{{ stats.dueNew }}</div> <div class="pw-div-vert"></div> <div class="pw-val">{{ stats.dueReview }}</div>
                            <div class="pw-label">Due Tomorrow</div>
                            <div class="pw-val">{{ stats.tomorrowNew }}</div> <div class="pw-div-vert"></div> <div class="pw-val">{{ stats.tomorrowReview }}</div>
                        </div>
                    </div>
                </div>

                <div class="menu-grid">
                    <button class="menu-btn" @click="nav('learn')"><span class="menu-icon">üéì</span><span class="menu-text">Learn</span></button>
                    <button class="menu-btn" @click="nav('wordReview')"><span class="menu-icon">üìö</span><span class="menu-text">Dictionary</span></button>
                    <button class="menu-btn" @click="nav('report')"><span class="menu-icon">üìä</span><span class="menu-text">Report</span></button>
                    <button class="menu-btn" @click="nav('settings')"><span class="menu-icon">‚öôÔ∏è</span><span class="menu-text">Settings</span></button>
                </div>
                <div class="center-msg" style="font-size:1.2rem; margin-top:20px; color:#ccc;">Version {{ appVersion }}</div>
            </div>
        </div>

        <div id="screen-learn" class="screen" :class="{ active: !loading.show && currentScreen === 'learn' }">
            <div class="app-header">
                <div style="width:50px;"></div> <div class="header-title">Review</div>
                <button class="btn-icon" @click="nav('menu')">üè†</button> 
            </div>

            <div class="flashcard-stage">
                <div class="progress-track">
                    <div class="progress-fill" :style="{ width: progressPercent + '%' }"></div>
                    <div class="progress-text">{{ progressText }}</div>
                </div>

                <div v-if="currentCard" id="flashcard-el" class="flashcard" :class="{ flipped: isFlipped, 'no-transition': disableTransition }" @click="flipCard">
                    <div class="face front">
                        <div class="face-header">
                            <span class="lang-flag">üá≥üá±</span>
                            <span class="card-status">{{ currentCard.type === 'new' ? 'NEW' : 'REVIEW' }}</span>
                        </div>
                        <div class="face-content">
                            <img v-if="currentCard.image_url" :src="currentCard.image_url" class="hint-image" :class="{ hidden: !showHint }" />
                            <div class="word-text">{{ currentCard.dutch }}</div>
                            <div v-if="currentCard.dutch_sentence" class="sentence-text">{{ currentCard.dutch_sentence }}</div>
                        </div>
                        
                        <button class="tts-btn" @click.stop="speakTTS">üîä</button>
                        <button v-if="currentCard.image_url" class="hint-btn" @click.stop="showHint = !showHint">üí°</button>
                        <button class="edit-card-btn" @click.stop="startEditCard(currentCard, 'learn')">Edit</button>
                    </div>

                    <div class="face back">
                        <div class="face-header">
                            <span class="lang-flag">üá¨üáß</span>
                            <span class="card-status">{{ currentCard.type === 'new' ? 'NEW' : 'REVIEW' }}</span>
                        </div>
                        <div class="face-content">
                            <div class="word-text" style="font-size:2.8rem;">{{ currentCard.english }}</div>
                            <div v-if="currentCard.english_sentence" class="sentence-text">{{ currentCard.english_sentence }}</div>
                        </div>
                        <button class="edit-card-btn" @click.stop="startEditCard(currentCard, 'learn')">Edit</button>
                    </div>
                </div>
                
                <div v-if="!currentCard && sessionStarted" class="center-msg">
                    <h2>üéâ All caught up!</h2>
                    <p>No more cards due right now.</p>
                </div>
            </div>

            <div class="review-controls" :class="{ hidden: !isFlipped }">
                <button class="rating-btn" style="background:#FF595E" @click="rate('again')">Again</button>
                <button class="rating-btn" style="background:#FFCA3A" @click="rate('hard')">Hard</button>
                <button class="rating-btn" style="background:#8AC926" @click="rate('good')">Good</button>
                <button class="rating-btn" style="background:#1982C4" @click="rate('easy')">Easy</button>
            </div>
        </div>

        <div id="screen-wordReview" class="screen" :class="{ active: currentScreen === 'wordReview' }">
            <div class="app-header">
                <div style="width:50px;"></div> <div class="header-title">Dictionary</div>
                <button class="btn-icon" @click="nav('menu')">üè†</button> 
            </div>
            
            <div class="fixed-controls">
                <input type="text" v-model="wordSearch" class="search-input" placeholder="Search...">
                
                <div class="filter-row">
                    <button class="filter-pill" :class="{active: wordFilter==='all'}" @click="wordFilter='all'">All</button>
                    <button class="filter-pill" :class="{active: wordFilter==='due'}" @click="wordFilter='due'">Due</button>
                    <button class="filter-pill" :class="{active: wordFilter==='new'}" @click="wordFilter='new'">New</button>
                    <button class="filter-pill" :class="{active: wordFilter==='suspended'}" @click="wordFilter='suspended'">Frozen</button>
                </div>

                <div style="text-align:right;">
                    <select v-model="sortCol" style="font-size:1.6rem; padding:5px;">
                        <option value="dutch">A-Z (Dutch)</option>
                        <option value="english">A-Z (English)</option>
                        <option value="last_reviewed">Recent</option>
                    </select>
                </div>
            </div>

            <div class="list-scroll">
                <div class="container-elevated">
                    <div style="color:#999; margin-bottom:10px; font-size:1.2rem;">{{ filteredWords.length }} Words</div>
                    <div v-for="c in filteredWords" :key="c.id" style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div class="ri-text">{{ c.dutch }}</div>
                            <div class="ri-sub">{{ c.english }}</div>
                            <div class="ri-sub" style="font-size:1.1rem; margin-top:5px;">
                                <span v-if="c.suspended" style="color:red; background:#ffebee; padding:2px 6px; border-radius:4px;">FROZEN</span>
                                <span v-else style="color:green; background:#e8f5e9; padding:2px 6px; border-radius:4px;">{{ c.type === 'new' ? 'NEW' : 'REVIEW' }}</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button style="font-size:1.5rem; border:none; background:none;" @click="startEditCard(c, 'wordReview')">‚úèÔ∏è</button>
                            <button style="font-size:1.5rem; border:none; background:none;" @click="toggleSuspend(c)">{{ c.suspended ? '‚ùÑÔ∏è' : 'üö´' }}</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="screen-editCard" class="screen" :class="{ active: currentScreen === 'editCard' }">
            <div class="app-header">
                <button class="btn-text" @click="cancelEdit">Cancel</button>
                <div class="header-title">Edit Card</div>
                <div style="width:50px;"></div>
            </div>
            <div class="content-scroll">
                <div class="container-elevated">
                    <label class="edit-label">Dutch Word</label>
                    <input class="edit-input" v-model="editForm.dutch" placeholder="Dutch">
                    
                    <label class="edit-label">English Definition</label>
                    <input class="edit-input" v-model="editForm.english" placeholder="English">

                    <label class="edit-label">Dutch Sentence</label>
                    <input class="edit-input" v-model="editForm.dutch_sentence" placeholder="Example in Dutch">

                    <label class="edit-label">English Sentence</label>
                    <input class="edit-input" v-model="editForm.english_sentence" placeholder="Example in English">
                    
                    <label class="edit-label">Image</label>
                    <div v-if="editForm.image_url">
                        <img :src="editForm.image_url" class="edit-preview-img">
                    </div>
                    <div v-else style="text-align:center; padding:20px; color:#999; border:1px dashed #ccc; border-radius:12px; margin-top:10px;">No Image Selected</div>
                    
                    <button class="btn-large btn-outline" @click="openImageSelector('editCard')">
                        {{ editForm.image_url ? 'Change Image' : 'Select Image' }}
                    </button>

                    <button class="btn-large" @click="saveEditCard">Save Changes</button>
                    
                    <button class="btn-large btn-danger" @click="deleteCard">Delete Card</button>
                </div>
            </div>
        </div>

        <div id="screen-selectImage" class="screen" :class="{ active: currentScreen === 'selectImage' }">
            <div class="app-header">
                <button class="btn-icon" @click="exitImageSelector">‚¨ÖÔ∏è</button>
                <div class="header-title">Select Image</div>
                <div style="width:50px;"></div>
            </div>
            <div class="content-scroll">
                <div class="container-elevated">
                    <div class="search-row">
                        <input v-model="imgSearchQuery" class="search-input" placeholder="Search Unsplash...">
                        <button class="menu-btn" style="width:auto; height:auto; padding:10px 20px; margin:0; min-height:0;" @click="searchImages">Go</button>
                    </div>
                    <div v-if="imgLoading" class="center-msg">Searching...</div>
                    <div class="image-grid">
                        <div v-for="img in imgResults" :key="img.id" class="image-item" 
                             :class="{ selected: selectedImageUrl === img.urls.regular }"
                             @click="selectedImageUrl = img.urls.regular">
                            <img :src="img.urls.thumb" />
                        </div>
                    </div>
                    <button class="menu-btn" style="margin-top:20px; background:var(--primary); color:white; aspect-ratio:auto; height:auto; padding:15px; font-size:1.6rem; min-height:0;" :disabled="!selectedImageUrl" @click="saveSelectedImage">
                        {{ imageReturnScreen === 'editCard' ? 'Use This Image' : 'Save Image' }}
                    </button>
                </div>
            </div>
        </div>

        <div id="screen-report" class="screen" :class="{ active: currentScreen === 'report' }">
            <div class="app-header">
                <div style="width:50px;"></div> <div class="header-title">Report</div>
                <button class="btn-icon" @click="nav('menu')">üè†</button> 
            </div>
            <div class="content-scroll">
                <div class="container-elevated">
                    <div class="chart-heading">Retention Rate (% Correct)</div>
                    <div id="retention-chart-div" class="chart-wrapper"></div>
                </div>
                <div class="container-elevated">
                    <div class="chart-heading">Mastery History</div>
                    <div id="mastery-history-chart" class="chart-wrapper"></div>
                </div>
                <div class="container-elevated">
                    <div class="chart-heading">Current Status</div>
                    <div id="status-chart-div" class="chart-wrapper"></div>
                </div>
            </div>
        </div>

        <div id="screen-settings" class="screen" :class="{ active: currentScreen === 'settings' }">
            <div class="app-header">
                <div style="width:50px;"></div> <div class="header-title">Settings</div>
                <button class="btn-icon" @click="nav('menu')">üè†</button> 
            </div>
            <div class="content-scroll">
                <div class="container-elevated">
                    <div class="header-title" style="font-size:1.8rem; margin-bottom:10px; position:relative; transform:none; left:auto;">Daily New Cards</div>
                    <select v-model="settingsMaxNew" style="width:100%; font-size:1.8rem; padding:15px; border-radius:12px;">
                        <option value="5">5 cards</option>
                        <option value="10">10 cards</option>
                        <option value="15">15 cards</option>
                        <option value="20">20 cards</option>
                        <option value="30">30 cards</option>
                    </select>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
import { APP_VERSION, SUPABASE_URL, SUPABASE_ANON_KEY, UNSPLASH_ACCESS_KEY, CONFIG_MAX_NEW } from './constants.js';

const CONFIG_RET_THRESHOLD = 'dutch_flashcards_ret_threshold';
const { createApp } = Vue;
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const app = createApp({
    data() {
        return {
            appVersion: APP_VERSION,
            currentScreen: 'menu',
            loading: { show: true, msg: 'Starting...' },
            allCards: [],
            reviewHistory: [],
            reviewBuffer: [],
            sessionQueue: [],
            sessionTotal: 0,
            currentIndex: 0,
            isFlipped: false,
            disableTransition: false,
            sessionStarted: false,
            showHint: false, 
            editForm: { id: null, dutch: '', english: '', dutch_sentence: '', english_sentence: '', image_url: '' },
            editReturnScreen: 'menu',
            cardToEdit: null,
            imgSearchQuery: '',
            imgResults: [],
            imgLoading: false,
            selectedImageUrl: null,
            imageReturnScreen: 'learn',
            cardForImage: null,
            wordSearch: '',
            wordFilter: 'all',
            sortCol: 'dutch',
            settingsMaxNew: '10',
            settingsRetentionThreshold: '0'
        };
    },
    computed: {
        stats() {
            if (!this.allCards.length) return { dueNew:0, dueReview:0, tomorrowNew:0, tomorrowReview:0 };
            const today = new Date().toISOString().slice(0, 10);
            const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
            const maxNewToday = this.getAdjustedMaxNew(yesterday);
            const newDone = this.allCards.filter(c => !c.suspended && c.first_seen && c.first_seen.slice(0, 10) === today).length;
            
            return {
                dueNew: Math.max(0, maxNewToday - newDone),
                dueReview: this.allCards.filter(c => !c.suspended && c.type !== "new" && c.due_date && c.due_date.slice(0, 10) <= today).length,
                tomorrowNew: this.getAdjustedMaxNew(today),
                tomorrowReview: this.allCards.filter(c => !c.suspended && c.type !== "new" && c.due_date && c.due_date.slice(0, 10) === new Date(Date.now() + 86400000).toISOString().slice(0, 10)).length
            };
        },
        currentCard() { return this.sessionQueue[this.currentIndex] || null; },
        progressPercent() { return this.sessionTotal ? ((this.sessionTotal - this.sessionQueue.length) / this.sessionTotal) * 100 : 0; },
        progressText() { 
            const completed = this.sessionTotal - this.sessionQueue.length;
            return `${Math.min(completed + 1, this.sessionTotal)} / ${this.sessionTotal}`; 
        },
        filteredWords() {
            const today = new Date().toISOString().slice(0, 10);
            let list = this.allCards.filter(c => {
                const match = (c.dutch||'').toLowerCase().includes(this.wordSearch.toLowerCase()) || (c.english||'').toLowerCase().includes(this.wordSearch.toLowerCase());
                if(!match) return false;
                if(this.wordFilter === 'suspended') return c.suspended;
                if(c.suspended) return false;
                if(this.wordFilter === 'new') return c.type === 'new';
                if(this.wordFilter === 'due') return (c.type !== 'new' && c.due_date && c.due_date.slice(0,10) <= today);
                return true;
            });
            list.sort((a,b) => (a[this.sortCol] || "") > (b[this.sortCol] || "") ? 1 : -1);
            return list.slice(0, 100); 
        }
    },
    async mounted() {
        try {
            this.settingsMaxNew = localStorage.getItem(CONFIG_MAX_NEW) || "10";
            this.settingsRetentionThreshold = localStorage.getItem(CONFIG_RET_THRESHOLD) || "0";
            let { data: cards } = await supabase.from("cards").select("*").range(0, 10000);
            this.allCards = cards || [];
            let { data: hist } = await supabase.from("reviewhistory").select("*");
            this.reviewHistory = hist || [];
            if(window.google) google.charts.load('current', {'packages':['corechart']});
            this.loading.show = false;
        } catch (e) { alert("Error: " + e.message); }
    },
    methods: {
        async nav(id) {
            if(id === 'menu') await this.saveProgress();
            this.currentScreen = id;
            if(id === 'learn') this.startSession();
            if(id === 'report') setTimeout(this.drawCharts, 500);
        },
        async saveProgress() {
            if(this.reviewBuffer.length > 0) {
                const toSend = [...this.reviewBuffer];
                this.reviewBuffer = [];
                await supabase.from("reviewhistory").insert(toSend);
                for(const r of toSend) {
                    const c = this.allCards.find(x => x.id === r.cardid);
                    if(c) await supabase.from("cards").update(c).eq("id", c.id);
                }
            }
            localStorage.setItem(CONFIG_MAX_NEW, this.settingsMaxNew);
            localStorage.setItem(CONFIG_RET_THRESHOLD, this.settingsRetentionThreshold);
        },
        getAdjustedMaxNew(dateToCheck) {
            const rawLimit = parseInt(this.settingsMaxNew || 10);
            const threshold = parseInt(this.settingsRetentionThreshold || 0);
            if (threshold === 0) return rawLimit;
            const dayReviews = this.reviewHistory.filter(r => r.timestamp.slice(0,10) === dateToCheck);
            if (dayReviews.length === 0) return rawLimit;
            const rate = (dayReviews.filter(r => r.rating !== 'again').length / dayReviews.length) * 100;
            return rate < threshold ? 0 : rawLimit;
        },
        startSession() {
            const today = new Date().toISOString().slice(0, 10);
            const max = this.getAdjustedMaxNew(new Date(Date.now() - 86400000).toISOString().slice(0, 10));
            const done = this.allCards.filter(c => c.first_seen && c.first_seen.slice(0,10)===today).length;
            
            let due = this.allCards.filter(c => !c.suspended && c.type!=="new" && c.due_date && c.due_date.slice(0,10)<=today);
            due.sort(() => Math.random() - 0.5);

            let n = this.allCards.filter(c => !c.suspended && c.type==="new");
            n.sort((a, b) => a.id - b.id); 
            
            const limit = Math.max(0, max - done);
            let combined = [...due, ...n.slice(0, limit)];
            combined.sort(() => Math.random() - 0.5);
            
            this.sessionQueue = combined;
            this.sessionTotal = this.sessionQueue.length;
            this.currentIndex = 0;
            this.sessionStarted = true;
            this.resetCard();
        },
        resetCard() {
            this.disableTransition = true;
            this.isFlipped = false;
            this.showHint = false;
            this.$nextTick(() => setTimeout(() => this.disableTransition=false, 50));
        },
        flipCard() { this.isFlipped = !this.isFlipped; },
        async rate(rating) {
            if(!this.currentCard) return;
            const c = this.currentCard;
            const now = new Date().toISOString();
            const type = c.type;
            c.reps = (c.reps||0)+1;
            
            if(c.type === "new") { c.type="review"; c.interval=1; c.ease=2.5; c.first_seen=now.slice(0,10); }

            if(rating==="again") { 
                c.lapses=(c.lapses||0)+1; c.interval=1; c.ease=Math.max(1.3, c.ease-0.2); 
            } else {
                let m = rating === "hard" ? 1.2 : rating === "good" ? c.ease : c.ease + 0.15;
                c.interval = Math.max(c.interval + 1, Math.round(c.interval * m));
                c.ease = Math.max(1.3, c.ease + (rating === "hard" ? -0.15 : rating === "easy" ? 0.15 : 0));
            }
            
            c.due_date = new Date(Date.now() + c.interval * 86400000).toISOString();
            c.last_reviewed = now.slice(0,10);
            this.reviewBuffer.push({ cardid:c.id, rating, timestamp:now, review_type:type });
            this.sessionQueue.splice(this.currentIndex, 1);
            if(this.reviewBuffer.length >= 5) this.saveProgress();
            this.resetCard();
        },
        speakTTS() {
            const u = new SpeechSynthesisUtterance(this.currentCard.dutch.replace(/\s*\(.*?\)/g, ""));
            u.lang = "nl-NL"; window.speechSynthesis.speak(u);
        },
        startEditCard(card, fromScreen) {
            this.cardToEdit = card;
            this.editReturnScreen = fromScreen;
            this.editForm = { ...card };
            this.currentScreen = 'editCard';
        },
        async saveEditCard() {
            this.loading.show = true;
            const { error } = await supabase.from("cards").update(this.editForm).eq("id", this.editForm.id);
            if (!error) Object.assign(this.cardToEdit, this.editForm);
            this.loading.show = false;
            this.currentScreen = this.editReturnScreen;
        },
        // ... (Charts and Image search functions remain unchanged from previous versions) ...
        drawCharts() {
            const commonOpts = { chartArea: { width: '85%', height: '70%' }, legend: { position: 'bottom' } };
            const mst = { new:0, learning:0, reviewing:0, mastered:0 };
            this.allCards.forEach(c => {
                if(c.suspended) return;
                if(c.type==='new') mst.new++; else if(c.interval <= 3) mst.learning++; else if(c.interval <= 21) mst.reviewing++; else mst.mastered++;
            });
            new google.visualization.PieChart(document.getElementById('status-chart-div')).draw(google.visualization.arrayToDataTable([['S','C'],['New',mst.new],['Lrn',mst.learning],['Rev',mst.reviewing],['Mst',mst.mastered]]), { ...commonOpts, colors:['#ADB5BD','#FFCA3A','#1982C4','#8AC926'] });
        }
    }
});
app.mount('#app');
</script>
</body>
</html>
